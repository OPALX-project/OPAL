OPTION, PSDUMPFREQ = 1000;   // 6d data written every 300 time steps (h5).
OPTION, STATDUMPFREQ = 1000;  // Beam Stats written every 10 time steps (stat).
OPTION, BOUNDPDESTROYFQ=10; // Delete lost particles, if any
OPTION, AUTOPHASE=4;        // Autophase is on, and phase of max energy
                            // gain will be found automatically for cavities.
OPTION, VERSION=10900;

REAL REPARTFREQ=1000000;

Title, string="UNDULATOR";

//----------------------------------------------------------------------------
//Global Parameters

REAL rf_freq             = 1.0;     //RF frequency. (Hz)
REAL n_particles         = 1224;      //Number of particles in simulation.
REAL beam_bunch_charge   =  1.6e-19 * 1e6 * 1.846e8;      //Charge of bunch. (C)

//Initial Momentum Calculation
REAL gamma   = 100.41; 
REAL beta    = sqrt(1-(1/gamma^2));
REAL P0      = gamma*beta*EMASS;    //inital z momentum

//Printing initial energy and momentum to terminal output.
value , {gamma, P0};


// Undulator

UND: UNDULATOR, L = 9.0, ELEMEDGE = 0.0, K = 1.417, LAMBDA = .03, 
     TRANTRUN = 1040e-6, LONGTRUN = 90e-6, 
     MESHLENGTH = { 3.2e-3, 3.2e-3, .28e-3 }, MESHRESOLUTION = {100e-6, 100e-6, .4e-6},
     TRUNORDER = 2, SPACECHARGE = 1,
     RADZ = 1.1e-4, RADLAMBDA = 1, RADDIRECTORY = "power-sampling/power",
     TOTALTIME = 3.003e-8, TIMESTEPRATIO = 5;

DRIVE: Line = (UND);

//----------------------------------------------------------------------------
// INITIAL DISTRIBUTION

Dist: DISTRIBUTION, TYPE = FROMFILE,
      	FNAME = "initial-profile-for-OPAL.tsv",
	EMITTED = FALSE;

	
//----------------------------------------------------------------------------
// Define Field solvers
// The mesh sizes should be a factor of 2 
// for most efficient space charge calculation.

FS_SC: Fieldsolver, FSTYPE = FFT, 
            MX = 8, MY = 8, MT = 8, // SC grid size is 8^3
            PARFFTX = true, 
            PARFFTY = true, 
            PARFFTT = true,  // parallel in the z direction only
            BCFFTX = open, 
            BCFFTY = open, 
            BCFFTT = open,
            BBOXINCR = 1, 
            GREENSF = INTEGRATED;

//----------------------------------------------------------------------------
// Electron Beam Definition

// BEAM1:  BEAM, PARTICLE = ELECTRON, pc = P0, NPART = n_particles,
//        BFREQ = rf_freq, BCURRENT = beam_bunch_charge * rf_freq, CHARGE = -1;

REAL mithra_time = 3e-8;
BEAM1:  BEAM, PARTICLE = ELECTRON, pc = P0, NPART = n_particles,
	BFREQ = 1 / mithra_time, BCURRENT = beam_bunch_charge / mithra_time , CHARGE = -1;

//----------------------------------------------------------------------------
// Simulate the beamline using TRACK and RUN.

TRACK, LINE = DRIVE, BEAM = BEAM1, MAXSTEPS = 1000000, DT = 3.E-10, ZSTOP= 10.0 ;
RUN, METHOD = "PARALLEL-T", BEAM = BEAM1, 
    FIELDSOLVER = FS_SC, DISTRIBUTION = Dist;
ENDTRACK;

Quit;
